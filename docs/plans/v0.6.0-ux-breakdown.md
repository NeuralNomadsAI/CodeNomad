# CodeNomad v0.6.0 UX Breakdown

## Session Tree (Threaded Sessions)

### Visual Structure

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Sessions Header                              [â†‘] [â†“]       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ðŸ‘¤ Implement login feature                    [â–¼]   â”‚â—€â”€â”€ Parent Session (User icon)
â”‚  â”‚    â— Working                    [ðŸ“‹] [âœï¸] [ðŸ—‘ï¸]     â”‚    Border: User color (left)
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    Expand/collapse chevron
â”‚      â”‚                                                      â”‚
â”‚      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚      â”‚ ðŸ¤– Fork: Fix auth bug                           â”‚â—€â”€â”€ Child Session (Bot icon)
â”‚      â”‚    â—‹ Idle                   [ðŸ“‹] [âœï¸] [ðŸ—‘ï¸]     â”‚    Border: Assistant color
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    Indented with tree line
â”‚      â”‚                                                      â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚        â”‚ ðŸ¤– Fork: Add OAuth                            â”‚â—€â”€â”€ Last child (line ends at 50%)
â”‚        â”‚    â—‹ Idle                 [ðŸ“‹] [âœï¸] [ðŸ—‘ï¸]     â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ðŸ‘¤ Debug performance issue                          â”‚â—€â”€â”€ Another parent (collapsed)
â”‚  â”‚    â—‹ Idle                       [ðŸ“‹] [âœï¸] [ðŸ—‘ï¸]     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [+ New Session]                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Key Visual Elements

#### 1. Parent Sessions
- **Icon**: `User` icon (ðŸ‘¤) - indicates human-initiated conversation
- **Border**: Left border in "user" color (typically blue)
- **Expand/Collapse**: Chevron icon (â–¼/â–º) if has children
- **Background**: Highlighted when active
- **Actions**: Copy ID, Rename, Delete (on hover/always visible)

#### 2. Child Sessions (Forks)
- **Icon**: `Bot` icon (ðŸ¤–) - indicates AI-spawned fork
- **Border**: Left border in "assistant" color (typically purple/green)
- **Indentation**: Left padding of 2.25rem
- **Tree Lines**:
  - Vertical line from parent to children
  - Horizontal connector line to each child
  - Last child has vertical line ending at 50% height
- **CSS Pseudo-elements**:
  ```css
  .session-item-child::before {
    /* Vertical line */
    left: 1.125rem;
    width: 1px;
    top: 0;
    bottom: 0;
  }
  .session-item-child::after {
    /* Horizontal connector */
    left: 1.125rem;
    width: 0.875rem;
    top: 50%;
  }
  .session-item-child-last::before {
    bottom: 50%; /* Line stops at connector */
  }
  ```

#### 3. Status Indicators
- **Idle**: Muted dot + "Idle" text
- **Working**: Animated pulsing dot + "Working" text (highlighted bg)
- **Compacting**: Animated pulsing dot + "Compacting" text
- **Permission**: Shield icon (ðŸ›¡ï¸) + "Needs Permission" text

### Behavior

#### Creating Child Sessions
1. User forks from a message in parent session
2. Fork creates new session with `parentId` pointing to parent
3. Parent automatically expands to show new child
4. Child becomes active session

#### Expand/Collapse
- Click chevron to toggle visibility of children
- Active session's parent auto-expands
- Collapsed state persisted per instance

#### Navigation
- Arrow keys navigate visible sessions only (collapsed children skipped)
- Selecting child auto-expands parent
- Delete moves to nearest visible session

#### Sorting
- Threads sorted by `latestUpdated` (max of parent and children updates)
- Children within thread sorted by update time (newest first)

---

## Slash Commands

### UX Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                â”‚
â”‚  Type: /commit fix auth bug                                    â”‚
â”‚        â†‘                                                       â”‚
â”‚        â””â”€â”€ Slash triggers command detection                    â”‚
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ /commit fix auth bug                              [Send] â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â†“ On Send

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ System detects "/commit" is a known command                    â”‚
â”‚                                                                â”‚
â”‚ Instead of sending as chat message:                            â”‚
â”‚ â†’ executeCustomCommand(instanceId, sessionId, "commit",        â”‚
â”‚                        "fix auth bug")                         â”‚
â”‚                                                                â”‚
â”‚ API Call: POST /command.run                                    â”‚
â”‚ {                                                              â”‚
â”‚   "command": "commit",                                         â”‚
â”‚   "arguments": "fix auth bug",                                 â”‚
â”‚   "messageID": "msg_xxx",                                      â”‚
â”‚   "agent": "current-agent",                                    â”‚
â”‚   "model": "current-model"                                     â”‚
â”‚ }                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Command Detection Logic

```typescript
// In prompt-input.tsx handleSend()

// 1. Check if input starts with /
const isSlashCandidate = !isShellMode && text.startsWith("/")

// 2. Extract command name and args
const firstSpace = text.indexOf(" ")
const commandToken = firstSpace === -1 ? text : text.slice(0, firstSpace)
const commandName = commandToken.slice(1)  // Remove leading /
const commandArgs = firstSpace === -1 ? "" : text.slice(firstSpace + 1).trimStart()

// 3. Verify command exists
const isKnownSlashCommand =
  isSlashCandidate &&
  commandName.length > 0 &&
  getCommands(instanceId).some((cmd) => cmd.name === commandName)

// 4. Route accordingly
if (isKnownSlashCommand) {
  await executeCustomCommand(instanceId, sessionId, commandName, commandArgs)
} else {
  await sendMessage(prompt, attachments)
}
```

### Key Behaviors

1. **Command Registry**
   - Commands fetched from OpenCode backend on instance load
   - Stored in `commandMap` signal keyed by instanceId
   - API: `client.command.list()`

2. **Attachment Handling**
   - Attachments are NOT sent with slash commands
   - They're preserved for the next regular message
   - Counter syncs but attachments remain in state

3. **History**
   - Slash commands recorded in prompt history
   - Can be recalled with up arrow

4. **Unknown Commands**
   - If `/foo` doesn't match any command, sent as regular message
   - No special handling - just plain text

### Command Types (from SDK)

```typescript
interface Command {
  name: string         // e.g., "commit", "review", "test"
  description?: string // Human-readable description
  // ... other fields defined by OpenCode
}
```

---

## Comparison: Our Current UX vs v0.6.0

### Session Management

| Aspect | Our Current (v0.4.0) | v0.6.0 |
|--------|---------------------|--------|
| Session List | Flat horizontal tabs | Hierarchical sidebar tree |
| Session Display | Tab with truncated title | Card with 2-line title, status |
| Parent/Child | Not visualized | Tree lines, icons, indentation |
| Expand/Collapse | N/A | Chevron toggle per parent |
| Status Display | Minimal | Rich status badges with icons |
| Navigation | Tab click | Keyboard nav through visible list |
| Fork Visualization | Creates new tab | Indented child under parent |

### Input Handling

| Aspect | Our Current (v0.4.0) | v0.6.0 |
|--------|---------------------|--------|
| Slash Commands | Not supported | Full support |
| Command Registry | N/A | Fetched from backend |
| @ Mentions | Supported | Supported |
| Shell Mode | Supported | Supported |

---

## Integration Considerations

### Session Tree Integration

**High Impact Areas:**
1. `session-list.tsx` - Complete replacement needed
2. `session-state.ts` - Add thread state management
3. `session-layout.css` - Add tree line styles
4. Remove our `session-tabs.tsx` horizontal tabs OR keep both

**Questions to Resolve:**
- Keep horizontal session tabs for compact view?
- Show tree in sidebar only?
- How to handle mobile/tablet breakpoints?

### Slash Commands Integration

**Low-Medium Impact:**
1. Add `stores/commands.ts` (new file)
2. Modify `prompt-input.tsx` - Add command detection
3. Modify `session-actions.ts` - Add `executeCustomCommand`
4. Add SDK v2 command types

**Dependencies:**
- Requires SDK v2 client
- Needs backend command.list API
- Needs backend command.run API

---

## Recommended Integration Order

### Phase 1: Slash Commands (Lower Risk)
1. Add commands store
2. Fetch commands on instance init
3. Add command detection to prompt input
4. Add executeCustomCommand action
5. Test with OpenCode built-in commands

### Phase 2: Session Tree (Higher Risk)
1. Add session thread types
2. Add expand/collapse state
3. Create new session list component
4. Add tree line CSS
5. Update navigation logic
6. Test parent-child relationships

---

*Document created: 2026-01-10*
