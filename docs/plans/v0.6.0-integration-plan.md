# CodeNomad v0.6.0 Integration Plan

**Current Version:** 0.4.0 (Era Code fork)
**Target Version:** 0.6.0
**Analysis Date:** 2026-01-10

---

## Executive Summary

Integrating v0.6.0 involves **4,866 additions and 1,150 deletions** across 78 files. The major features are:
1. **Threaded Sessions (Session Tree)** - Parent-child session hierarchy
2. **Slash Commands** - Custom command execution from prompt
3. **Permission Center** - Enhanced approval workflow with modal UI

We have **10 conflicting files** that require manual merge resolution.

---

## Change Analysis

### New Files in v0.6.0 (16 files)

| File | Feature | Priority |
|------|---------|----------|
| `permission-approval-modal.tsx` | Permission Center | High |
| `permission-notification-banner.tsx` | Permission Center | High |
| `permission-notification.css` | Permission Center | High |
| `types/permission.ts` | Permission Center | High |
| `background-process-output-dialog.tsx` | Background Processes | Medium |
| `stores/background-processes.ts` | Background Processes | Medium |
| `server/routes/background-processes.ts` | Background Processes | Medium |
| `server/background-processes/manager.ts` | Background Processes | Medium |
| `lib/ansi.ts` | ANSI rendering | Low |
| `lib/clipboard.ts` | Clipboard utility | Low |
| `lib/opencode-api.ts` | OpenCode SDK bridge | Medium |
| `server/plugins/channel.ts` | Plugin system | Low |
| `server/plugins/handlers.ts` | Plugin system | Low |
| `server/routes/plugin.ts` | Plugin system | Low |
| `server/opencode-config.ts` | Config management | Low |
| `server/scripts/copy-opencode-config.mjs` | Build script | Low |

### Conflicting Files (10 files requiring manual merge)

| File | Our Changes | Upstream Changes | Conflict Risk |
|------|-------------|------------------|---------------|
| `App.tsx` | Session deletion fix, deleteSession import | Permission center integration, session tree | **HIGH** |
| `session-api.ts` | Select nearby session after delete | Session tree state, permission handling | **HIGH** |
| `http-server.ts` | Models proxy route registration | Plugin routes, background process routes | **MEDIUM** |
| `server/index.ts` | Minor changes | Background process manager | **LOW** |
| `instance-tab.tsx` | Tab close visibility | Session status indicator badge | **MEDIUM** |
| `sdk-manager.ts` | Minor changes | V2 SDK migration | **MEDIUM** |
| `api-client.ts` | API base URL handling | OpenCode API integration | **LOW** |
| `use-app-lifecycle.ts` | Minor changes | Permission center hooks | **MEDIUM** |
| `panels.css` | Empty-loading styles | Major restructuring (211 deletions) | **HIGH** |
| `tokens.css` | Token variables | New permission tokens | **LOW** |

### Heavily Modified Files (non-conflicting)

| File | Lines Changed | Feature |
|------|---------------|---------|
| `session-state.ts` | +340 | Session tree, indicator counts |
| `session-list.tsx` | +323 | Threaded session UI |
| `instance-shell2.tsx` | +360 | Permission integration |
| `permission-approval-modal.tsx` | +251 | Permission modal |
| `session-events.ts` | +223 | Session tree events |
| `message-v2/instance-store.ts` | +172 | Message state |
| `prompt-input.tsx` | +108 | Slash commands |

---

## Feature Breakdown

### 1. Threaded Sessions (Session Tree)

**Scope:** Large
**Risk:** High
**Dependencies:** session-state.ts, session-list.tsx, session-api.ts, sessions.ts

**What it does:**
- Sessions now have parent-child relationships
- Sidebar shows collapsible session threads
- Navigation follows visible session list
- Active session tracking considers tree structure

**Files affected:**
- `stores/session-state.ts` - New `SessionThread` type, expand/collapse state
- `components/session-list.tsx` - Complete rewrite for threaded display
- `stores/session-api.ts` - Tree-aware deletion and navigation
- `stores/sessions.ts` - Re-exports tree functions

**Integration approach:**
1. Copy new types and state management from session-state.ts
2. Replace session-list.tsx entirely (our changes were minimal)
3. Carefully merge session-api.ts (our nearby-session fix may conflict)
4. Update sessions.ts exports

### 2. Slash Commands

**Scope:** Medium
**Risk:** Medium
**Dependencies:** prompt-input.tsx, stores/commands.ts, session-actions.ts

**What it does:**
- `/command` syntax triggers custom commands
- Commands defined in OpenCode configuration
- Attachments preserved across command execution

**Files affected:**
- `components/prompt-input.tsx` - Command detection and routing
- `stores/commands.ts` - Command registry
- `stores/session-actions.ts` - Command execution

**Integration approach:**
1. Merge prompt-input.tsx changes (mostly additive)
2. Copy command store updates
3. Add SDK command type imports

### 3. Permission Center

**Scope:** Large
**Risk:** Medium
**Dependencies:** New files + instance integration

**What it does:**
- Centralized permission approval UI
- Modal shows tool details with queue navigation
- Permission-blocked calls shown in timeline
- Auto-close when queue empties

**New files to add:**
- `components/permission-approval-modal.tsx`
- `components/permission-notification-banner.tsx`
- `types/permission.ts`
- `styles/components/permission-notification.css`

**Files to merge:**
- `stores/instances.ts` - Permission queue state
- `components/instance-shell2.tsx` - Modal integration
- `components/tool-call.tsx` - Permission status display

**Integration approach:**
1. Copy all new permission files
2. Add permission state to instances store
3. Integrate modal into instance shell
4. Update tool-call for permission display

---

## Risk Assessment

### High Risk Areas

1. **App.tsx Integration**
   - Our changes: deleteSession import, handleCloseSession fix
   - Their changes: Permission center, session tree integration
   - Strategy: Manual 3-way merge required
   - Mitigation: Create backup, test each feature independently

2. **session-api.ts Integration**
   - Our changes: Select nearby session after delete
   - Their changes: Tree-aware session management
   - Strategy: Their implementation may supersede ours
   - Mitigation: Verify tree-aware deletion handles active session

3. **panels.css Restructuring**
   - Upstream deleted 211 lines, moved to component CSS
   - Our changes: empty-loading.css additions
   - Strategy: May need to relocate our styles
   - Mitigation: Identify where upstream moved styles

### Medium Risk Areas

1. **SDK Version Compatibility**
   - v0.6.0 uses `@opencode-ai/sdk/v2`
   - Need to verify SDK compatibility
   - May require dependency updates

2. **Instance Tab Changes**
   - Both modified instance-tab.tsx
   - Our changes: Close button visibility
   - Their changes: Status indicator badge
   - Strategy: Both changes should be compatible

3. **State Management Changes**
   - Session state significantly expanded
   - New indicator counts, thread expansion state
   - May affect our session stores

### Low Risk Areas

1. **New Files** - Can be added without conflict
2. **tokens.css** - Simple variable additions
3. **Server routes** - Additive changes

---

## Integration Strategy

### Phase 1: Preparation (1-2 hours)

1. Create integration branch from current main
2. Backup all conflicting files
3. Document current test state
4. Update SDK dependencies to match v0.6.0

### Phase 2: Non-Conflicting Changes (2-3 hours)

1. Copy all new files from v0.6.0
2. Add new dependencies
3. Update type definitions
4. Add new CSS files

### Phase 3: Low-Risk Merges (1-2 hours)

1. Merge tokens.css
2. Merge api-client.ts
3. Merge server/index.ts
4. Update SDK imports

### Phase 4: Medium-Risk Merges (2-3 hours)

1. Merge instance-tab.tsx (combine our close button + their badge)
2. Merge sdk-manager.ts
3. Merge use-app-lifecycle.ts
4. Merge http-server.ts (add all new routes)

### Phase 5: High-Risk Merges (3-4 hours)

1. **session-api.ts**
   - Review their nearby-session implementation
   - Merge if compatible, else adapt ours to tree structure

2. **App.tsx**
   - 3-way merge with careful conflict resolution
   - Test deleteSession flow
   - Test permission center integration

3. **panels.css**
   - Map our empty-loading changes to new structure
   - Verify no style regressions

### Phase 6: Feature Testing (2-3 hours)

1. Test threaded sessions
   - Create parent session
   - Fork to create child
   - Verify expand/collapse
   - Delete session, verify tree updates

2. Test slash commands
   - Add test command to config
   - Execute via prompt
   - Verify command routing

3. Test permission center
   - Trigger permission request
   - Verify modal appears
   - Test approve/deny flow
   - Verify queue navigation

4. Test our existing fixes
   - CORS proxy for models.dev
   - Tab close button visibility
   - Context display
   - Session deletion

### Phase 7: Regression Testing (1-2 hours)

1. Full application smoke test
2. Verify all existing functionality
3. Check for console errors
4. Visual inspection of UI

---

## Estimated Total Effort

| Phase | Time Estimate |
|-------|---------------|
| Preparation | 1-2 hours |
| Non-Conflicting | 2-3 hours |
| Low-Risk Merges | 1-2 hours |
| Medium-Risk Merges | 2-3 hours |
| High-Risk Merges | 3-4 hours |
| Feature Testing | 2-3 hours |
| Regression Testing | 1-2 hours |
| **Total** | **12-19 hours** |

---

## Recommendations

### Do First
1. **Permission Center** - Most isolated, clearest value
2. **Slash Commands** - Medium complexity, high user value

### Do Carefully
3. **Threaded Sessions** - Highest complexity, touches most files

### Consider Deferring
- Background process UI (nice-to-have)
- Plugin system (not critical for ERA Code)

### Keep Our Changes
- CORS proxy for models.dev ✅ (they don't have this)
- White provider icons ✅ (our improvement)
- Tab close button visibility ✅ (merge with their badge)
- Context display improvements ✅ (may need adjustment)
- Keyboard shortcuts footer ✅ (keep as-is)

---

## Alternative Approach: Cherry-Pick

Instead of full merge, consider cherry-picking specific commits:

```bash
# Permission Center
git cherry-pick f01a06d  # centralized permission notification system
git cherry-pick 888e365  # enhance permission modal
git cherry-pick df9fc52  # rework permission center to reuse tool call view
git cherry-pick e30c8b0  # auto-close permission center

# Slash Commands
git cherry-pick cb2966f  # slash command prompt support

# Session Tree
git cherry-pick e50d9f4  # thread sessions in sidebar list
git cherry-pick 1a7aefc  # session nav follows visible list

# Bug Fixes
git cherry-pick 1081bfb  # keep session view after delete
git cherry-pick ab38cdc  # simplify prompt input hints
```

**Pros:** More control, easier conflict resolution
**Cons:** May miss dependencies, more manual work

---

## Decision Required

1. **Full merge vs cherry-pick?**
2. **Which features to prioritize?**
3. **Timeline constraints?**
4. **Testing resources available?**

---

*Plan created: 2026-01-10*
